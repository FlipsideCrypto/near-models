version: 2

models:
  - name: defi__fact_bridge_activity
    description: |-
      This fact table contains all NEAR Protocol cross-chain bridge transactions with detailed token flow and bridge protocol metadata. It serves as the primary source of truth for bridge activity data in the gold layer, providing normalized access to cross-chain transfers, bridge protocols, token amounts, and destination chains. The model transforms raw bridge data from multiple bridge protocols (Rainbow, Wormhole, Multichain, Allbridge, Omni) into structured columns for efficient querying and analysis. It includes critical bridge information such as source/destination chains, token addresses, transfer amounts, bridge protocols, and execution status. This table is essential for cross-chain analytics, bridge volume tracking, interoperability analysis, and capital flow monitoring. The data flows from multiple bridge protocol silver models with chain ID mapping applied to standardize blockchain names. This table represents the most complete view of cross-chain activity involving NEAR, enabling detailed analysis of capital flows, bridge adoption, and ecosystem connectivity patterns.
    tests:
      - dbt_utils.recency:
          datepart: day
          field: block_timestamp
          interval: 1

    columns:
      - name: BLOCK_ID
        description: "{{ doc('block_id')}}"
        tests:
          - not_null

      - name: BLOCK_TIMESTAMP
        description: "{{ doc('block_timestamp')}}"
        tests:
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'

      - name: TX_HASH
        description: "{{ doc('tx_hash')}}"
        tests:
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'

      - name: TOKEN_ADDRESS
        description: "{{ doc('token_contract')}}"
        tests:
          - not_null:
              where: receipt_succeeded

      - name: AMOUNT_UNADJ
        description: "{{ doc('amount_raw')}}"
        tests:
          - not_null:
              where: receipt_succeeded

      - name: AMOUNT_ADJ
        description: "{{ doc('amount_adj')}}"
        tests:
          - not_null:
              where: receipt_succeeded

      - name: DESTINATION_ADDRESS
        description: "{{ doc('destination_address')}}"

      - name: SOURCE_ADDRESS
        description: "{{ doc('source_address')}}"

      - name: PLATFORM
        description: "{{ doc('platform')}}"
        tests:
          - not_null

      - name: BRIDGE_ADDRESS
        description: "{{ doc('contract_address')}}"
        tests:
          - not_null

      - name: DESTINATION_CHAIN
        description: "{{ doc('destination_chain')}}"
        tests:
          - not_null:
              where: receipt_succeeded and platform != 'multichain'

      - name: SOURCE_CHAIN
        description: "{{ doc('source_chain')}}"
        tests:
          - not_null:
              where: receipt_succeeded and platform != 'multichain'

      - name: METHOD_NAME
        description: "{{ doc('method_name')}}"
        tests:
          - not_null

      - name: DIRECTION
        description: "{{ doc('direction')}}"
        tests:
          - not_null

      - name: RECEIPT_SUCCEEDED
        description: "{{ doc('receipt_succeeded')}}"
        tests:
          - not_null

      - name: FACT_BRIDGE_ACTIVITY_ID
        description: "{{ doc('id')}}"
        tests:
          - unique:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'

      - name: INSERTED_TIMESTAMP
        description: "{{ doc('inserted_timestamp')}}"

      - name: MODIFIED_TIMESTAMP
        description: "{{ doc('modified_timestamp')}}"
