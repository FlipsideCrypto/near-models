version: 2
models:
  - name: defi__fact_lending
    description: |-
      This fact table contains all NEAR Protocol lending protocol transactions with detailed borrowing and lending activity metadata. It serves as the primary source of truth for lending protocol data in the gold layer, providing normalized access to lending actions, amounts, token types, and protocol interactions. The model transforms raw lending data from silver__burrow_lending into structured columns for efficient querying and analysis. It includes critical lending information such as platform identification, action types, token amounts, contract addresses, and user interactions. This table is essential for DeFi lending analytics, protocol usage tracking, risk assessment, and capital efficiency analysis. The data flows from blockchain transactions through silver__burrow_lending, with action parsing applied to extract structured lending activity data. This table represents the most complete view of lending activity on NEAR, enabling detailed analysis of borrowing patterns, lending volumes, and protocol adoption across all supported lending platforms.
    tests:
      - dbt_utils.recency:
          datepart: hours
          field: block_timestamp
          interval: 24

    columns:
      - name: platform
        description: "Lending protocol"
        tests:
          - not_null

      - name: TX_HASH
        description: "{{ doc('tx_hash')}}"
        tests:
          - not_null

      - name: block_id
        description: "{{ doc('block_id')}}"
        tests:
          - not_null

      - name: BLOCK_TIMESTAMP
        description: "{{ doc('block_timestamp')}}"
        tests:
          - not_null:
              where: inserted_timestamp <= current_timestamp - interval '1 hour'

      - name: SENDER_ID
        description: "{{ doc('sender_id')}}"
        tests:
          - not_null

      - name: ACTIONS
        description: "{{ doc('action')}}"
        tests:
          - not_null

      - name: CONTRACT_ADDRESS
        description: "{{ doc('contract_address')}}"
        tests:
          - not_null

      - name: AMOUNT_RAW
        description: "{{ doc('amount_raw')}}"
        tests:
          - not_null:
              where: token_address not in ('shadow_ref_v1-4179', 'v2-nearx.stader-labs.near')

      - name: AMOUNT_ADJ
        description: "{{ doc('amount_adj')}}"
        tests:
          - not_null:
              where: token_address not in ('shadow_ref_v1-4179', 'v2-nearx.stader-labs.near')

      - name: TOKEN_ADDRESS
        description: "{{ doc('token_contract')}}"
        tests:
          - not_null

      - name: FACT_LENDING_ID
        description: "{{ doc('id')}}"
        tests:
          - not_null
