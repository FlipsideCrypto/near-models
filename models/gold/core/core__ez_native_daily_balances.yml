version: 2

models:
  - name: core__ez_native_daily_balances
    description: |-
      This easy-access table contains NEAR Protocol account balance snapshots with detailed staking and lockup information on a daily epoch basis. It serves as the primary analytics-ready table for account balance data in the gold layer, providing normalized access to liquid balances, staked amounts, rewards, and lockup account relationships. The model transforms raw balance data from the NEAR Public Lakehouse through silver__native_daily_balances into structured columns for efficient querying and analysis. It includes critical balance information such as liquid NEAR, staked amounts, accumulated rewards, storage usage, and lockup account relationships. This table is essential for account analytics, staking analysis, whale tracking, and economic activity monitoring. The data flows from the NEAR Public Lakehouse (bigquery-public-data.crypto_near_mainnet_us.ft_balances_daily) through silver__native_daily_balances, with epoch-based snapshots providing daily balance history. This table represents the most complete view of NEAR account financial positions, enabling detailed analysis of staking patterns, capital allocation, and economic behavior.
      Please Note - Flipside does not index or curate the data in this table, we simply provide it as-is from the NEAR Public Lakehouse with a daily sync from the public access table located at `bigquery-public-data.crypto_near_mainnet_us.ft_balances_daily`.
    tests:
      - dbt_utils.recency:
          datepart: day
          field: epoch_date
          interval: 3

    columns:
      - name: account_id
        description: The NEAR account address for which the balance is recorded.
        tests:
          - not_null:
              where: epoch_date > SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'

      - name: epoch_block_id
        description: The max block id in for the epoch.
        tests:
          - not_null:
              where: epoch_date > SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'  

      - name: epoch_date
        description: The date and time at which the epoch began
        tests:
          - not_null:
              where: epoch_date > SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days' 

      - name: liquid
        description: The liquid balance of the NEAR account at this epoch.
        tests:
          - not_null:
              where: epoch_date > SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days' 

      - name: lockup_account_id
        description: The lockup delegator account ID for the NEAR account, if one exists.

      - name: lockup_liquid
        description: Liquid balance of the lockup account at this epoch.

      - name: lockup_reward
        description: Lockup reward balance of the lockup account at this epoch.

      - name: lockup_staked
        description: Lockup staked balance of the lockup account at this epoch.

      - name: lockup_unstaked_not_liquid
        description: Lockup unstaked but not liquid balance of the lockup account at this epoch.

      - name: reward
        description: The accumulated reward balance of the NEAR account earned from staking at this epoch.

      - name: staked
        description: The staked balance of the NEAR account at this epoch.
        tests:
          - not_null:
              where: epoch_date > SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days' 

      - name: storage_usage
        description: Storage usage of the NEAR account at this epoch.

      - name: unstaked_not_liquid
        description: Unstaked but not liquid balance of the NEAR account at this epoch.

      - name: ez_near_daily_balances_id
        description: "{{doc('id')}}"
        tests:
          - unique:
              where: epoch_date > SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days' 
          - not_null:
              where: epoch_date > SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days' 

      - name: INSERTED_TIMESTAMP
        description: "{{doc('inserted_timestamp')}}"

      - name: MODIFIED_TIMESTAMP
        description: "{{doc('modified_timestamp')}}"
