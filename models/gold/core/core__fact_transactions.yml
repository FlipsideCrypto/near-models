version: 2

models:
  - name: core__fact_transactions
    description: |-
      Comprehensive fact table containing all NEAR Protocol blockchain transactions with detailed execution metadata and gas consumption information. This model serves as the primary source of truth for transaction-level data in the gold layer, providing normalized access to transaction details, execution outcomes, and fee structures. The model transforms raw JSON transaction data from the silver layer into structured columns for efficient querying and analysis. It includes critical transaction information such as nonces, signatures, gas usage, fees, and execution success status. This table is essential for transaction analytics, fee analysis, user activity tracking, and smart contract interaction monitoring. The data flows from bronze__transactions through silver__transactions_final, with JSON parsing applied to extract structured fields from the transaction payload and execution outcomes.

    tests:
      - dbt_utils.recency:
          datepart: hours
          field: block_timestamp
          interval: 2

    columns:
      - name: BLOCK_ID
        description: "{{ doc('block_id')}}"
        tests:
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - NUMBER
                - FLOAT

      - name: BLOCK_HASH
        description: "{{ doc('block_hash')}}"
        tests:
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - STRING
                - VARCHAR

      - name: TX_HASH
        description: "{{ doc('tx_hash')}}"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - STRING
                - VARCHAR

      - name: BLOCK_TIMESTAMP
        description: "{{ doc('block_timestamp')}}"
        tests:
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - TIMESTAMP_NTZ
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'

      - name: NONCE
        description: "{{ doc('nonce')}}"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - NUMBER

      - name: SIGNATURE
        description: "{{ doc('signature')}}"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - STRING
                - VARCHAR

      - name: TX_RECEIVER
        description: "{{ doc('tx_receiver')}}"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - STRING
                - VARCHAR

      - name: TX_SIGNER
        description: "{{ doc('tx_signer')}}"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - STRING
                - VARCHAR

      - name: TX
        description: "{{ doc('tx')}}"
        tests:
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - OBJECT
                - VARIANT

      - name: GAS_USED
        description: "{{ doc('gas_used')}}"
        tests:
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - NUMBER
                - FLOAT

      - name: ATTACHED_GAS
        description: "{{ doc('attached_gas')}}"
        tests:
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - NUMBER
                - FLOAT

      - name: TRANSACTION_FEE
        description: "{{ doc('transaction_fee')}}"
        tests:
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - NUMBER
                - FLOAT

      - name: TX_SUCCEEDED
        description: "{{ doc('tx_succeeded')}}"
        tests:
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - BOOLEAN

      - name: FACT_TRANSACTIONS_ID
        description: "{{doc('id')}}"
        tests:
          - unique:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'

      - name: INSERTED_TIMESTAMP
        description: "{{doc('inserted_timestamp')}}"
        
      - name: MODIFIED_TIMESTAMP
        description: "{{doc('modified_timestamp')}}"
