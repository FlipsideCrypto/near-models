version: 2

models:
  - name: gov__fact_staking_actions
    description: |-
      Comprehensive fact table containing all NEAR Protocol staking actions with detailed pool interactions and decimal-adjusted amounts for governance analytics. This model serves as the primary source of truth for staking activity data in the gold layer, providing normalized access to staking, deposit, unstaking, and withdrawal actions across all staking pools. The model transforms raw staking data from silver__staking_actions_v2 into structured columns for efficient querying and analysis. It includes critical staking information such as action types, pool addresses, amounts with decimal adjustments (10^24), and transaction context. This table is essential for staking analytics, validator performance tracking, governance participation monitoring, and economic activity analysis. The data flows from blockchain logs through silver__staking_actions_v2, with comprehensive log parsing applied to capture all staking-related actions rather than just first receipts. This table represents the most comprehensive view of NEAR staking activity, enabling detailed analysis of staking patterns, validator behavior, and governance participation across all supported staking pools.
    tests:
      - dbt_utils.recency:
          datepart: day
          field: block_timestamp
          interval: 1

    columns:
      - name: TX_HASH
        description: "{{ doc('tx_hash') }}"
        tests:
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'

      - name: BLOCK_ID
        description: "{{ doc('block_id') }}"
        tests:
          - not_null

      - name: BLOCK_TIMESTAMP
        description: "{{ doc('block_timestamp') }}"
        tests:
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'

      - name: RECEIPT_OBJECT_ID
        description: "{{ doc('receipt_object_id') }}"
        tests:
          - not_null

      - name: ADDRESS
        description: "{{ doc('pool_address') }}"
        tests:
          - not_null

      - name: PREDECESSOR_ID
        description: "{{ doc('predecessor_id') }}"
        tests:
          - not_null

      - name: SIGNER_ID
        description: "{{ doc('signer_id') }}"
        tests:
          - not_null

      - name: ACTION
        description: "{{ doc('staking_action') }}"
        tests:
          - not_null

      - name: AMOUNT
        description: "{{ doc('amount') }}"
        tests:
          - not_null

      - name: FACT_STAKING_ACTIONS_ID
        description: "{{doc('id')}}"
        tests:
          - unique:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'

      - name: INSERTED_TIMESTAMP
        description: "{{doc('inserted_timestamp')}}"

      - name: MODIFIED_TIMESTAMP
        description: "{{doc('modified_timestamp')}}"
