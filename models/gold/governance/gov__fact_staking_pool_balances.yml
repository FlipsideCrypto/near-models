version: 2

models:
  - name: gov__fact_staking_pool_balances
    description: |-
      Comprehensive fact table containing all NEAR Protocol staking pool balance changes with transaction-based updates and decimal-adjusted amounts for governance analytics. This model serves as the primary source of truth for staking pool balance data in the gold layer, providing normalized access to pool balance updates triggered by individual staking actions. The model transforms raw pool balance data from silver__pool_balances into structured columns for efficient querying and analysis. It includes critical balance information such as pool addresses, balance amounts with decimal adjustments (10^24), and transaction context. This table is essential for staking pool analytics, validator performance tracking, balance history analysis, and governance participation monitoring. The data flows from blockchain logs through silver__pool_balances, with transaction-based balance updates captured for each staking event. This table represents the most comprehensive view of staking pool balance changes on NEAR, enabling detailed analysis of pool growth, validator competition, and staking distribution patterns across all supported staking pools.
    tests:
      - dbt_utils.recency:
          datepart: day
          field: block_timestamp
          interval: 1

    columns:
      - name: TX_HASH
        description: "{{ doc('tx_hash') }}"
        tests:
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'

      - name: BLOCK_ID
        description: "{{ doc('block_id') }}"
        tests:
          - not_null

      - name: BLOCK_TIMESTAMP
        description: "{{ doc('block_timestamp') }}"
        tests:
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'

      - name: RECEIPT_OBJECT_ID
        description: "{{ doc('receipt_object_id') }}"
        tests:
          - not_null

      - name: ADDRESS
        description: "{{ doc('pool_address') }}"
        tests:
          - not_null

      - name: BALANCE
        description: "{{ doc('balance') }}"
        tests:
          - not_null

      - name: FACT_STAKING_POOL_BALANCES_ID
        description: "{{doc('id')}}"
        tests:
          - unique:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'

      - name: INSERTED_TIMESTAMP
        description: "{{doc('inserted_timestamp')}}"

      - name: MODIFIED_TIMESTAMP
        description: "{{doc('modified_timestamp')}}"
