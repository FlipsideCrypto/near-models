version: 2

models:
  - name: gov__dim_staking_pools
    description: |-
      Comprehensive dimension table containing NEAR Protocol registered staking pools with detailed ownership and fee structure information for governance analytics. This model serves as the primary source of truth for staking pool reference data in the gold layer, providing normalized access to pool addresses, owners, reward fee structures, and registration events. The model transforms raw staking pool data from silver__staking_pools_s3 into structured columns for efficient querying and analysis. It includes critical pool information such as pool addresses, owner accounts, reward fee fractions, transaction types (Create/Update), and registration timestamps. This table is essential for staking pool analytics, validator identification, fee structure analysis, and governance participation tracking. The data flows from blockchain transactions through silver__staking_pools_s3, with pool registration and update events captured to provide comprehensive pool context. This table supports understanding of NEAR staking ecosystem structure, validator competition, and governance participation patterns across all registered staking pools.

    tests:
      - dbt_utils.recency:
          datepart: day
          field: block_timestamp
          interval: 30

    columns:
      - name: TX_HASH
        description: "{{ doc('tx_hash') }}"
        tests:
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - STRING
                - VARCHAR

      - name: BLOCK_TIMESTAMP
        description: "{{ doc('block_timestamp')}}"
        tests:
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - TIMESTAMP_NTZ

      - name: OWNER
        description: "{{ doc('staking_pool_owner')}}"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - STRING
                - VARCHAR

      - name: ADDRESS
        description: "{{ doc('staking_pool_address')}}"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - STRING
                - VARCHAR

      - name: REWARD_FEE_FRACTION
        description: "{{ doc('staking_pool_reward_fee_fraction')}}"
        tests:
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - VARIANT
                - OBJECT

      - name: TX_TYPE
        description: "{{ doc('staking_pool_tx_type') }}"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list:
                - STRING
                - VARCHAR
          - dbt_expectations.expect_column_values_to_be_in_set:
              value_set: ["Create", "Update"]

      - name: DIM_STAKING_POOLS_ID
        description: "{{doc('id')}}"
        tests:
          - unique:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'
          - not_null:
              where: inserted_timestamp >= SYSDATE() - INTERVAL '{{ var('DBT_TEST_LOOKBACK_DAYS', 14) }} days'

      - name: INSERTED_TIMESTAMP
        description: "{{doc('inserted_timestamp')}}"

      - name: MODIFIED_TIMESTAMP
        description: "{{doc('modified_timestamp')}}"
